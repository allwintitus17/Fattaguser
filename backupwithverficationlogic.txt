import { useEffect, useState } from 'react'; 
import { useSelector, useDispatch } from 'react-redux'; 
import { useNavigate } from 'react-router-dom'; 
import { toast } from 'react-toastify'; 
import { SignJWT } from 'jose'; 
import BackButton from '../components/BackButton'; 
import Spinner from '../components/Spinner'; 
import UpiPaymentGateway from '../components/UpiPaymentGateway'; // Import the UPI component
import {    
  createPersonalDetails,    
  resetPersonal  
} from '../features/kyc/personalSlice'; 
import {    
  createVehicle,    
  resetVehicle  
} from '../features/vehicle/vehicleSlice';
import {
  createPayment,
  resetPayment
} from '../features/payment/paymentSlice'; // Import payment actions
import { jwtDecode } from 'jwt-decode'; 

const jwtEncode = require('jwt-encode');  

// Constants for PAN verification 
const SECRET_KEY = 'Kejb4MDZRn76TezXogXDGNj0AADoyuPC-81Zs64D77eSzWOipuMBfrd9ks6i7v60HDKVgvWOXsqv6RaLb6Y_8w'; 
const ALGORITHM = 'HS512'; 
const AADHAAR_PRIVATE_KEY = "HLMVSD1767HJJJBi864VCEHHGC65676P67HUUIYDTSDUVKVU907784567NXU789IP"; 
const AADHAAR_ALGORITHM = 'ES256'; 

function NewFastTag() {   
  const { user } = useSelector((state) => state.auth);   
  const {      
    isLoading: personalLoading,      
    isError: personalError,      
    isSuccess: personalSuccess,      
    message: personalMessage,
    personalDetails // Add this to get created personal details
  } = useSelector((state) => state.kyc);      
  
  const {      
    isLoading: vehicleLoading,      
    isError: vehicleError,      
    isSuccess: vehicleSuccess,      
    message: vehicleMessage,
    vehicle // Add this to get created vehicle
  } = useSelector((state) => state.vehicle);

  // Payment state
  const {
    isLoading: paymentLoading,
    isError: paymentError,
    isSuccess: paymentSuccess,
    message: paymentMessage,
    paymentStatus
  } = useSelector((state) => state.payment);

  const dispatch = useDispatch();   
  const navigate = useNavigate(); 

  // Form step state (now 3 steps)
  const [currentStep, setCurrentStep] = useState(1);      
  
  // Track validation states   
  const [personalDataValidated, setPersonalDataValidated] = useState(false);   
  const [vehicleDataValidated, setVehicleDataValidated] = useState(false);
  const [paymentCompleted, setPaymentCompleted] = useState(false);

  // UPI Payment Modal state
  const [showPaymentModal, setShowPaymentModal] = useState(false);
  const [createdVehicleId, setCreatedVehicleId] = useState(null);
  const [createdPersonalDetailsId, setCreatedPersonalDetailsId] = useState(null);

  // Verification states   
  const [isPanVerified, setIsPanVerified] = useState(false);   
  const [isPanVerifying, setIsPanVerifying] = useState(false);   
  const [isAadharVerified, setIsAadharVerified] = useState(false);   
  const [isAadharVerifying, setIsAadharVerifying] = useState(false);    

  const [aadharOtp, setAadharOtp] = useState('');   
  const [serverOtp, setServerOtp] = useState('');   
  const [isOtpSent, setIsOtpSent] = useState(false);   
  const [isOtpVerified, setIsOtpVerified] = useState(false);    

  // Vehicle verification states   
  const [isVehicleVerified, setIsVehicleVerified] = useState(false);   
  const [isVehicleVerifying, setIsVehicleVerifying] = useState(false);

  // Personal Details State   
  const [personalData, setPersonalData] = useState({     
    fullName: user?.name || '',     
    dob: '',     
    aadharNumber: '',     
    panNumber: '',     
    line1: '',     
    city: '',     
    state: '',     
    pincode: ''   
  });    

  // Vehicle Details State   
  const [vehicleData, setVehicleData] = useState({     
    registrationNumber: '',     
    vehicleType: '',     
    chassisNumber: '',     
    engineNumber: '',     
    model: '',     
    fuelType: '',     
    registrationYear: ''   
  });    

  // Vehicle class amounts for payment   
  const vehicleClassAmounts = {     
    "Class 1 - Car / Jeep / Van": 500,     
    "Class 2 - Light Commercial Vehicle (LCV)": 800,     
    "Class 3 - Bus / Truck (2 Axles)": 1200,     
    "Class 4 - 3-Axle Commercial Vehicles": 1500,     
    "Class 5 - 4 to 6 Axle Vehicles": 2000,     
    "Class 6 - 7 or more Axle Vehicles": 2500,     
    "Class 7 - Oversized Vehicles (Earth movers, etc.)": 3000   
  };

  // Handle personal success/error
  useEffect(() => {
    if (personalError) {
      toast.error(personalMessage);
      dispatch(resetPersonal());
    }

    if (personalSuccess && personalDetails) {
      toast.success('Personal details saved successfully');
      setCreatedPersonalDetailsId(personalDetails._id); // Store the created ID
      dispatch(resetPersonal());
    }
  }, [personalError, personalSuccess, personalMessage, personalDetails, dispatch]);

  // Handle vehicle success/error
  useEffect(() => {
    if (vehicleError) {
      toast.error(vehicleMessage);
      dispatch(resetVehicle());
    }

    if (vehicleSuccess && vehicle) {
      toast.success('Vehicle details saved successfully');
      setCreatedVehicleId(vehicle._id); // Store the created ID
      dispatch(resetVehicle());
    }
  }, [vehicleError, vehicleSuccess, vehicleMessage, vehicle, dispatch]);

  // Handle payment success/error
  useEffect(() => {
    if (paymentError) {
      toast.error(paymentMessage);
      dispatch(resetPayment());
    }

    if (paymentStatus === 'success') {
      setPaymentCompleted(true);
      setShowPaymentModal(false);
      toast.success('Payment completed successfully!');
      
      // Redirect to mytag.jsx after successful payment
      setTimeout(() => {
        navigate('/mytag');
      }, 2000);
    }
  }, [paymentError, paymentMessage, paymentStatus, dispatch, navigate]);

  // Handle form changes   
  const handlePersonalChange = (e) => {     
    const { name, value } = e.target;     
    setPersonalData({       
      ...personalData,       
      [name]: value     
    });      

    // Reset verification status when PAN number changes     
    if (name === 'panNumber') {       
      setIsPanVerified(false);     
    }     
    if (name === 'aadharNumber') {       
      setIsAadharVerified(false);     
    }   
  };    

  const handleVehicleChange = (e) => {     
    const { name, value } = e.target;     
    setVehicleData({       
      ...vehicleData,       
      [name]: value     
    });      

    // Reset vehicle verification status when any field changes     
    setIsVehicleVerified(false);   
  };    

  // PAN Verification Function   
  const handleVerifyPAN = async () => {     
    try {       
      console.log('Starting PAN verification...');       
      const panNumber = personalData.panNumber;              
      
      if (!panNumber) {         
        toast.error("Enter PAN number first");         
        return;       
      }        

      // Validate PAN format       
      const panRegex = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;       
      if (!panRegex.test(panNumber)) {         
        toast.error("Please enter a valid PAN number format (ABCDE1234F)");         
        return;       
      }        

      setIsPanVerifying(true);       
      console.log('Verifying PAN:', panNumber);        

      // JWT creation       
      let pan_token;       
      try {         
        if (typeof SignJWT !== 'undefined') {           
          const payload = { pan_number: panNumber };           
          const secret = new TextEncoder().encode(SECRET_KEY);           
          pan_token = await new SignJWT(payload)             
            .setProtectedHeader({ alg: ALGORITHM })             
            .sign(secret);         
        } else {           
          const payload = { pan_number: panNumber, timestamp: Date.now() };           
          pan_token = btoa(JSON.stringify(payload));           
          console.log('Using fallback token creation');         
        }       
      } catch (jwtError) {         
        console.error('JWT creation error:', jwtError);         
        const payload = { pan_number: panNumber, timestamp: Date.now() };         
        pan_token = btoa(JSON.stringify(payload));       
      }        

      console.log('Token created, making API call...');        

      // Access token       
      const accessToken = "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhbGx3aW4iLCJyb2xlIjoidXNlciJ9.lQhWXYdn7m1DDsyO2HnufevN_44J86nY_kywUgQrgV4ZU7ViQBa_vCOQLTO7I0Cs7xX-RRQrxbMuKo0hdBI-Fw";
      
      if (!accessToken) {         
        toast.error("Access token not found.");         
        setIsPanVerifying(false);         
        return;       
      }        

      // API call       
      const response = await fetch('http://192.168.172.12:8000/pancard/validate', {         
        method: 'POST',         
        headers: {           
          'Authorization': `Bearer ${accessToken}`,           
          'Content-Type': 'application/json',         
        },         
        body: JSON.stringify({           
          pan_token: pan_token         
        }),       
      });        

      console.log('API Response status:', response.status);       
      const data = await response.json();       
      console.log('API Response data:', data);        

      if (response.ok && data.result_token) {         
        try {           
          const tokenParts = data.result_token.split('.');           
          const payloadBase64 = tokenParts[1];           
          const decodedPayload = JSON.parse(atob(payloadBase64));           
          console.log('Decoded payload:', decodedPayload);                      
          
          if (decodedPayload.message && decodedPayload.message.toLowerCase() === 'valid') {             
            setIsPanVerified(true);             
            toast.success(`PAN Status: ${decodedPayload.message}`);           
          } else {             
            toast.error(`PAN Status: ${decodedPayload.message || 'Invalid'}`);           
          }         
        } catch (decodeError) {           
          console.error('Token decode error:', decodeError);           
          toast.error('Error processing verification response');         
        }       
      } else {         
        console.error('API Error:', data);         
        toast.error(`Verification failed: ${data.error || data.message || 'Unknown error'}`);       
      }     
    } catch (err) {       
      console.error('PAN verification failed:', err);       
      toast.error(`Error verifying PAN: ${err.message || 'Network error'}`);     
    } finally {       
      setIsPanVerifying(false);     
    }   
  };    

  // Decode JWT OTP function   
  const decodeJwtOtp = (jwtToken) => {     
    try {       
      if (typeof jwtDecode === 'function') {         
        console.log('Using imported jwtDecode function');         
        return jwtDecode(jwtToken);       
      }        

      console.log('jwtDecode not available, using manual decoding');              
      
      // Manual JWT decoding fallback       
      const parts = jwtToken.split('.');       
      if (parts.length !== 3) {         
        throw new Error('Invalid JWT format - expected 3 parts');       
      }              

      // Decode the payload (second part)       
      const payload = JSON.parse(atob(parts[1]));       
      console.log('Manually decoded JWT payload:', payload);       
      return payload;     
    } catch (error) {       
      console.error('Error decoding JWT OTP:', error);              

      // Final fallback - try to extract any 6-digit number from the token       
      try {         
        const digitMatch = jwtToken.match(/\d{6}/);         
        if (digitMatch) {           
          console.log('Found 6-digit number in token:', digitMatch[0]);           
          return { otp: digitMatch[0] };         
        }       
      } catch (regexError) {         
        console.error('Regex fallback also failed:', regexError);       
      }              

      return null;     
    }   
  };    

  // Aadhar OTP sending function   
  const handleSendAadharOtp = async () => {     
    try {       
      const aadharNumber = personalData.aadharNumber;        

      if (!aadharNumber) {         
        toast.error("Please enter Aadhar number first");         
        return;       
      }        

      if (!/^\d{16}$/.test(aadharNumber)) {         
        toast.error("Please enter a valid 16-digit Aadhar number");         
        return;       
      }        

      setIsAadharVerifying(true);       
      console.log('Starting Aadhar verification for:', aadharNumber);        

      let encodedAadhaarNumber;       
      try {         
        encodedAadhaarNumber = jwtEncode(aadharNumber, AADHAAR_PRIVATE_KEY, AADHAAR_ALGORITHM);         
        console.log('JWT Encoded Aadhar:', encodedAadhaarNumber);       
      } catch (jwtError) {         
        console.error('JWT encoding error:', jwtError);         
        toast.error("Error encoding Aadhar number");         
        return;       
      }        

      const requestPayload = {         
        uniqueID: encodedAadhaarNumber       
      };       
      console.log('Request payload:', requestPayload);        

      const response = await fetch("https://j6s1rnmt-5000.inc1.devtunnels.ms/check/aadhaar", {         
        method: 'POST',         
        headers: {           
          'Content-Type': 'application/json'         
        },         
        body: JSON.stringify(requestPayload)       
      });        

      console.log('Response status:', response.status);       
      const data = await response.json();       
      console.log("Full API Response:", data);        

      if (response.ok) {         
        if (data.success === true || data.status === 'success' || data.otp || data.mailOTP) {           
          toast.success("OTP sent successfully to your registered mobile number");           
          setIsOtpSent(true);                      
          
          let otpToken = data.mailOTP || data.otp || data.otpToken;                      

          if (otpToken) {             
            console.log('OTP Token received:', otpToken);                          
            
            const decodedOtp = decodeJwtOtp(otpToken);             
            if (decodedOtp) {               
              console.log('Decoded OTP data:', decodedOtp);               
              setServerOtp(decodedOtp.otp || decodedOtp.mailOTP || decodedOtp);             
            } else {               
              console.log('Storing JWT token as-is');               
              setServerOtp(otpToken);             
            }           
          } else {             
            console.warn('No OTP token in response, but API call was successful');             
            setServerOtp('123456'); // Fallback for testing           
          }                      
          
          setAadharOtp('');         
        } else {           
          console.error('API returned success status but error data:', data);           
          toast.error(`${data.message || data.error || 'Invalid Aadhar number'}`);         
        }       
      } else {         
        console.error('API returned error status:', response.status, data);         
        toast.error(`Server Error: ${data.message || data.error || 'Failed to send OTP'}`);       
      }      
    } catch (error) {       
      console.error("Aadhar OTP sending failed:", error);       
      toast.error(`Network Error: ${error.message || 'Failed to connect to server'}`);     
    } finally {       
      setIsAadharVerifying(false);     
    }   
  };    

  // OTP verification function   
  const handleVerifyOtp = () => {     
    if (!aadharOtp || aadharOtp.length !== 6) {       
      toast.error("Please enter a valid 6-digit OTP");       
      return;     
    }      

    let actualOtp = null;          
    console.log('Server OTP token:', serverOtp);          
    
    try {       
      if (typeof serverOtp === 'string' && serverOtp.includes('.')) {         
        console.log('Decoding JWT token...');                  
        
        let decodedOtp = null;                  

        // Try using the decodeJwtOtp function         
        decodedOtp = decodeJwtOtp(serverOtp);                  

        if (decodedOtp) {           
          actualOtp = decodedOtp.otp ||                       
                      decodedOtp.mailOTP ||                       
                      decodedOtp.code ||                       
                      decodedOtp.otpCode ||                      
                      decodedOtp.verification_code ||                      
                      decodedOtp.pin ||                      
                      (typeof decodedOtp === 'string' ? decodedOtp : null) ||                      
                      (typeof decodedOtp === 'number' ? String(decodedOtp) : null);                                 
          
          console.log('Extracted OTP from JWT:', actualOtp);                      

          if (!actualOtp) {             
            console.log('No OTP found in standard fields. Full decoded object:', decodedOtp);             
            const otpRegex = /\b\d{6}\b/;             
            const stringPayload = JSON.stringify(decodedOtp);             
            const match = stringPayload.match(otpRegex);             
            if (match) {               
              actualOtp = match[0];               
              console.log('Found 6-digit number in payload:', actualOtp);             
            }           
          }         
        }       
      } else {         
        actualOtp = serverOtp;         
        console.log('Using server OTP directly:', actualOtp);       
      }              
      
      actualOtp = String(actualOtp);              

      console.log('Final comparison:', {         
        entered: aadharOtp,         
        server: actualOtp,         
        serverType: typeof actualOtp       
      });        

      if (aadharOtp === actualOtp) {         
        setIsOtpVerified(true);         
        setIsAadharVerified(true);         
        toast.success("Aadhar OTP verified successfully");       
      } else {         
        toast.error("Incorrect OTP. Please try again.");         
        console.log('OTP mismatch details:', {           
          enteredOTP: aadharOtp,           
          expectedOTP: actualOtp,           
          enteredLength: aadharOtp.length,           
          expectedLength: actualOtp ? actualOtp.length : 'null'         
        });       
      }            
    } catch (error) {       
      console.error('Error during OTP verification:', error);       
      toast.error("Error verifying OTP. Please try again.");     
    }   
  };    

  // Vehicle verification function   
  const handleVerifyVehicle = async () => {     
    try {       
      console.log('Starting vehicle verification...');       
      const { registrationNumber, chassisNumber, engineNumber } = vehicleData;              
      
      if (!registrationNumber) {         
        toast.error("Please enter vehicle registration number");         
        return;       
      }        

      if (!chassisNumber) {         
        toast.error("Please enter chassis number");         
        return;       
      }        

      if (!engineNumber) {         
        toast.error("Please enter engine number");         
        return;       
      }        

      setIsVehicleVerifying(true);       
      console.log('Verifying vehicle with details:', { registrationNumber, chassisNumber, engineNumber });        

      const requestBody = {         
        reg_no: registrationNumber.trim(),         
        chassis_no: chassisNumber.trim(),         
        engine_no: engineNumber.trim()       
      };        

      console.log('Vehicle verification request body:', requestBody);        

      const apiUrl = `http://192.168.162.57:3000/api/vehicle/verify_RC`; 
      console.log('API URL:', apiUrl);        

      const response = await fetch(apiUrl, {         
        method: 'POST',         
        headers: {           
          'x-api-key': 'e2f8b7c6d5a4f3e2b1c0d9e8f7a6b5c4d3e2f1a0b9c8d7e6f5a4b3c2d1e0f9a8',
          'Content-Type': 'application/json',           
          'Accept': 'application/json',         
        },         
        body: JSON.stringify(requestBody),       
      });        

      console.log('Vehicle API Response status:', response.status);        

      const responseText = await response.text();       
      console.log('Raw response:', responseText);        

      let data;       
      try {         
        data = JSON.parse(responseText);       
      } catch (parseError) {         
        console.error('JSON parse error:', parseError);         
        console.error('Response was:', responseText);                  

        if (responseText.includes('<!DOCTYPE html>') || responseText.includes('<html>')) {           
          throw new Error(`API endpoint returned HTML page instead of JSON. This usually means the endpoint URL is incorrect or the server route doesn't exist. Status: ${response.status}`);         
        }                  

        throw new Error(`Server returned invalid JSON: ${parseError.message}`);       
      }        

      console.log('Vehicle API Response data:', data);        

      if (response.ok) {         
        if (response.status === 200 && data.message === "Vehicle RC Verified Successfully.") {           
          setIsVehicleVerified(true);           
          toast.success('Vehicle RC verified successfully');           
          console.log("Verified Vehicle ID:", data.vehicle_id);
          return true;         
        } else {           
          toast.error(`Vehicle verification failed: ${data.message || 'Unknown error'}`);           
          return false;         
        }       
      } else {         
        if (response.status === 400) {           
          toast.error(`Bad Request: ${data.message || 'Missing required fields'}`);         
        } else if (response.status === 401) {           
          toast.error(`Unauthorized: ${data.message || 'Invalid API key'}`);         
        } else if (response.status === 403) {           
          toast.error(`Vehicle Not Verified: ${data.message || 'Vehicle verification pending'}`);         
        } else if (response.status === 404) {           
          toast.error(`Vehicle Not Found: ${data.message || 'Vehicle details do not match'}`);         
        } else if (response.status === 500) {           
          toast.error(`Server Error: ${data.message || 'Database error'}`);         
        } else {           
          toast.error(`Error: ${data.message || `HTTP ${response.status}`}`);         
        }         
        return false;       
      }     
    } catch (err) {       
      console.error('Vehicle verification failed:', err);              

      if (err.message.includes('Failed to fetch')) {         
        toast.error('Cannot connect to server. Please check if the API server is running on 192.168.162.57');       
      } else if (err.message.includes('HTML page instead of JSON')) {         
        toast.error('API endpoint error: Server returned HTML instead of JSON. Check the endpoint URL.');       
      } else if (err.message.includes('CORS')) {         
        toast.error('CORS error: Please configure CORS on your backend server');       
      } else if (err.name === 'SyntaxError' || err.message.includes('JSON')) {         
        toast.error('Server returned invalid response format');       
      } else {         
        toast.error(`Error verifying vehicle: ${err.message || 'Network error'}`);       
      }       
      return false;     
    } finally {       
      setIsVehicleVerifying(false);     
    }   
  };

  // Personal details form submission   
  const onPersonalSubmit = (e) => {     
    e.preventDefault();      

    if (!user || !user._id) {       
      toast.error('User not logged in');       
      return;     
    }      

    if (!isPanVerified) {       
      toast.error('Please verify your PAN number first');       
      return;     
    }      

    if (!isAadharVerified) {       
      toast.error('Please verify your Aadhar number first');       
      return;     
    }      

    const personalPayload = {         
      authUserId: user._id,         
      fullName: personalData.fullName,         
      dob: personalData.dob,         
      aadharNumber: personalData.aadharNumber,         
      panNumber: personalData.panNumber,         
      address: {           
        line1: personalData.line1,           
        city: personalData.city,           
        state: personalData.state,           
        pincode: personalData.pincode,         
      },       
    };

    dispatch(createPersonalDetails(personalPayload));
    setPersonalDataValidated(true);     
    toast.success('Personal details validated successfully');     
    setCurrentStep(2);   
  };    

  // Vehicle details form submission
  const onVehicleSubmit = async (e) => {     
    e.preventDefault();      

    if (!personalDataValidated) {       
      toast.error('Please complete personal details first');       
      return;     
    }      

    // Validate all vehicle fields are filled     
    if (!vehicleData.registrationNumber || !vehicleData.chassisNumber || !vehicleData.engineNumber) {       
      toast.error('Please fill all required vehicle details');       
      return;     
    }      

    // Call vehicle verification API and wait for result     
    const verificationSuccess = await handleVerifyVehicle();      

    if (verificationSuccess) {       
      setVehicleDataValidated(true);       
      toast.success('Vehicle details validated successfully');              

      const vehiclePayload = {         
        ownerId: user._id,         
        registrationNumber: vehicleData.registrationNumber,         
        vehicleType: vehicleData.vehicleType,         
        chassisNumber: vehicleData.chassisNumber,         
        engineNumber: vehicleData.engineNumber,         
        model: vehicleData.model,         
        fuelType: vehicleData.fuelType,         
        registrationYear: parseInt(vehicleData.registrationYear),       
      };

      dispatch(createVehicle(vehiclePayload));
      toast.success('Vehicle details submitted successfully!');
      
      // Move to payment step
      setCurrentStep(3);
            
    } else {       
      toast.error('Please fix vehicle verification issues before proceeding');     
    }   
  };    

  // Updated Payment submission - now opens UPI modal instead of redirecting
  const handlePaymentSubmit = (e) => {
    e.preventDefault();
    
    const amount = vehicleClassAmounts[vehicleData.vehicleType];
    
    if (!amount || isNaN(amount)) {
      toast.error('Invalid payment amount');
      return;
    }

    if (!createdVehicleId || !createdPersonalDetailsId) {
      toast.error('Please ensure all details are saved before proceeding to payment');
      return;
    }

    // Open UPI Payment Modal
    setShowPaymentModal(true);
  };

  // Handle payment modal close
  const handlePaymentModalClose = () => {
    setShowPaymentModal(false);
    dispatch(resetPayment());
  };

  const goToPreviousStep = () => {     
    if (currentStep === 2) {       
      setCurrentStep(1);     
    } else if (currentStep === 3) {
      setCurrentStep(2);
    }   
  };    

  if (personalLoading || vehicleLoading || paymentLoading) {     
    return <Spinner />;   
  }    

  return (     
    <>       
      <BackButton />       
      <section className="heading">         
        <h1>Apply for FastTag</h1>         
        <p>Step {currentStep} of 3: {           
          currentStep === 1 ? 'Personal Information' : 
          currentStep === 2 ? 'Vehicle Details' : 'Payment'
        }</p>       
      </section>        

      {/* Progress Bar (Updated for 3 steps) */}       
      <div className="progress-bar">         
        <div className={`step ${currentStep >= 1 ? 'active' : ''}`}>           
          <span>1</span> Personal Details {personalDataValidated && '✓'}         
        </div>         
        <div className={`step ${currentStep >= 2 ? 'active' : ''}`}>           
          <span>2</span> Vehicle Details {vehicleDataValidated && '✓'}         
        </div>       
        <div className={`step ${currentStep >= 3 ? 'active' : ''}`}>           
          <span>3</span> Payment {paymentCompleted && '✓'}         
        </div>       
      </div>        

      {/* Step 1: Personal Details */}       
      {currentStep === 1 && (         
        <section className="form">           
          <h2>Personal Information</h2>           
          <p style={{ color: '#666', marginBottom: '1rem' }}>             
            Fill your personal details and verify your documents           
          </p>           
          <form onSubmit={onPersonalSubmit}>             
            <div className="form-group">               
              <label>Full Name</label>               
              <input                 
                type="text"                 
                name="fullName"                 
                className="form-control"                 
                value={personalData.fullName}                 
                onChange={handlePersonalChange}                 
                required               
              />             
            </div>              

            <div className="form-group">               
              <label>Date of Birth</label>               
              <input                 
                type="date"                 
                name="dob"                 
                className="form-control"                 
                value={personalData.dob}                 
                onChange={handlePersonalChange}                 
                required               
              />             
            </div>              

            <div className="form-group">               
              <label>PAN Number</label>               
              <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>                 
                <input                   
                  type="text"                   
                  name="panNumber"                   
                  className="form-control"                   
                  value={personalData.panNumber}                   
                  onChange={handlePersonalChange}                   
                  placeholder="Please Enter Your Pan"                   
                  pattern="^[A-Z]{5}[0-9]{4}[A-Z]{1}$"                   
                  style={{ textTransform: 'uppercase', flex: 1 }}                   
                  required                 
                />                 
                <button                   
                  type="button"                   
                  onClick={handleVerifyPAN}                   
                  disabled={!personalData.panNumber || isPanVerifying || isPanVerified}                   
                  style={{                     
                    padding: '10px 16px',                     
                    backgroundColor: isPanVerified ? '#28a745' : '#007bff',                     
                    color: 'white',                     
                    border: 'none',                     
                    borderRadius: '4px',                     
                    cursor: (!personalData.panNumber || isPanVerifying || isPanVerified) ? 'not-allowed' : 'pointer',                     
                    minWidth: '100px',                     
                    fontSize: '14px',                     
                    fontWeight: '500',                     
                    opacity: (!personalData.panNumber || isPanVerifying) && !isPanVerified ? '0.6' : '1'                   
                  }}                 
                >                   
                  {isPanVerifying ? 'Verifying...' : isPanVerified ? '✓ Verified' : 'Verify'}                 
                </button>               
              </div>               
              {isPanVerified && (                 
                <small style={{ color: '#28a745', fontSize: '0.9rem', marginTop: '5px', display: 'block' }}>                   
                  ✓ PAN number verified successfully                 
                </small>               
              )}             
            </div>              

            <div className="form-group">               
              <label>Aadhar Number (16-digit)</label>               
              <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>                 
                <input                   
                  type="text"                   
                  name="aadharNumber"                   
                  className="form-control"                   
                  value={personalData.aadharNumber}                   
                  onChange={(e) => {                     
                    handlePersonalChange(e);                     
                    // Reset OTP states when Aadhar number changes                     
                    setIsOtpSent(false);                     
                    setIsOtpVerified(false);                     
                    setIsAadharVerified(false);                     
                    setAadharOtp('');                     
                    setServerOtp('');                   
                  }}                   
                  placeholder="Enter 16-digit Aadhar number"                   
                  pattern="^\d{16}$"                   
                  maxLength="16"                   
                  style={{ flex: 1 }}                   
                  disabled={isOtpVerified}                   
                  required                 
                />                 
                <button                   
                  type="button"                   
                  onClick={handleSendAadharOtp}                   
                  disabled={!personalData.aadharNumber || isAadharVerifying || isOtpVerified}                   
                  style={{                     
                    padding: '10px 16px',                     
                    backgroundColor: isOtpVerified ? '#28a745' : isOtpSent ? '#ffc107' : '#007bff',                     
                    color: isOtpSent && !isOtpVerified ? '#000' : 'white',                     
                    border: 'none',                     
                    borderRadius: '4px',                     
                    cursor: (!personalData.aadharNumber || isAadharVerifying || isOtpVerified) ? 'not-allowed' : 'pointer',                     
                    minWidth: '100px',                     
                    fontSize: '14px',                     
                    fontWeight: '500',                     
                    opacity: (!personalData.aadharNumber || isAadharVerifying) && !isOtpVerified ? '0.6' : '1'                   
                  }}                 
                >                   
                  {isAadharVerifying ? 'Sending...' :                     
                    isOtpVerified ? '✓ Verified' :                     
                    isOtpSent ? 'Resend OTP' : 'Send OTP'}                 
                </button>               
              </div>                

              {/* OTP Input Field - Appears after OTP is sent */}               
              {isOtpSent && !isOtpVerified && (                 
                <div style={{                    
                  marginTop: '15px',                    
                  padding: '15px',                    
                  backgroundColor: '#f8f9fa',                    
                  borderRadius: '8px',                   
                  border: '1px solid #e9ecef'                 
                }}>                   
                  <label style={{                      
                    fontSize: '14px',                      
                    fontWeight: '600',                      
                    marginBottom: '8px',                     
                    display: 'block',                     
                    color: '#495057'                   
                  }}>                     
                    Enter 6-digit OTP sent to your registered mobile number                   
                  </label>                   
                  <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>                     
                    <input                       
                      type="text"                       
                      className="form-control"                       
                      value={aadharOtp}                       
                      onChange={(e) => {                         
                        const otp = e.target.value.replace(/\D/g, ''); // Only allow digits                         
                        if (otp.length <= 6) {                           
                          setAadharOtp(otp);                                                      
                          // Auto-verify when 6 digits are entered                           
                          if (otp.length === 6) {                             
                            setTimeout(() => {                               
                              handleVerifyOtp();                             
                            }, 500); // Small delay for better UX                           
                          }                         
                        }                       
                      }}                       
                      placeholder="Enter OTP"                       
                      maxLength="6"                       
                      style={{                          
                        flex: 1,                         
                        textAlign: 'center',                         
                        fontSize: '18px',                         
                        letterSpacing: '2px',                         
                        fontWeight: '600'                       
                      }}                       
                      autoComplete="off"                       
                      required                     
                    />                     
                    <button                       
                      type="button"                       
                      onClick={handleVerifyOtp}                       
                      disabled={aadharOtp.length !== 6}                       
                      style={{                         
                        padding: '10px 16px',                         
                        backgroundColor: aadharOtp.length === 6 ? '#28a745' : '#6c757d',                         
                        color: 'white',                         
                        border: 'none',                         
                        borderRadius: '4px',                         
                        cursor: aadharOtp.length === 6 ? 'pointer' : 'not-allowed',                         
                        minWidth: '100px',                         
                        fontSize: '14px',                         
                        fontWeight: '500'                       
                      }}                     
                    >                       
                      Verify OTP                     
                    </button>                   
                  </div>                   
                  <small style={{                      
                    color: '#6c757d',                      
                    fontSize: '12px',                      
                    marginTop: '8px',                      
                    display: 'block'                    
                  }}>                     
                    Didn't receive OTP? Click "Resend OTP" button above                   
                  </small>                 
                </div>               
              )}                

              {/* Success Message */}               
              {isOtpVerified && isAadharVerified && (                 
                <div style={{                    
                  marginTop: '10px',                   
                  padding: '10px',                   
                  backgroundColor: '#d4edda',                   
                  border: '1px solid #c3e6cb',                   
                  borderRadius: '4px'                 
                }}>                   
                  <small style={{                      
                    color: '#155724',                      
                    fontSize: '14px',                      
                    fontWeight: '600',                     
                    display: 'flex',                     
                    alignItems: 'center',                     
                    gap: '5px'                   
                  }}>                     
                    ✓ Aadhar number verified successfully                   
                  </small>                 
                </div>               
              )}             
            </div>              

            <div className="form-group">               
              <label>Address Line 1</label>               
              <input                 
                type="text"                 
                name="line1"                 
                className="form-control"                 
                value={personalData.line1}                 
                onChange={handlePersonalChange}                 
                required               
              />             
            </div>              

            <div className="form-group">               
              <label>City</label>               
              <input                 
                type="text"                 
                name="city"                 
                className="form-control"                 
                value={personalData.city}                 
                onChange={handlePersonalChange}                 
                required               
              />             
            </div>              

            <div className="form-group">               
              <label>State</label>               
              <input                 
                type="text"                 
                name="state"                 
                className="form-control"                 
                value={personalData.state}                 
                onChange={handlePersonalChange}                 
                required               
              />             
            </div>              

            <div className="form-group">               
              <label>Pincode</label>               
              <input                 
                type="text"                 
                name="pincode"                 
                className="form-control"                 
                value={personalData.pincode}                 
                onChange={handlePersonalChange}                 
                pattern="^\d{6}$"                 
                placeholder="123456"                 
                required               
              />             
            </div>              

            <div className="form-group">               
              <button                  
                type="submit"                  
                className="btn btn-block"                 
                disabled={!isPanVerified || !isAadharVerified}               
              >                 
                Next: Vehicle Details               
              </button>               
              {(!isPanVerified || !isAadharVerified) && (                 
                <small style={{ color: '#dc3545', fontSize: '0.9rem', marginTop: '5px', display: 'block' }}>                   
                  Please verify both PAN and Aadhar numbers to proceed                 
                </small>               
              )}             
            </div>           
          </form>         
        </section>       
      )}        

      {/* Step 2: Vehicle Details */}       
      {currentStep === 2 && (         
        <section className="form">           
          <h2>Vehicle Information</h2>           
          <p style={{ color: '#666', marginBottom: '1rem' }}>             
            Fill all vehicle details and verify your vehicle information           
          </p>           
          
          <form onSubmit={onVehicleSubmit}>             
            <div className="form-group">               
              <label>Registration Number *</label>               
              <input                 
                type="text"                 
                name="registrationNumber"                 
                className="form-control"                 
                value={vehicleData.registrationNumber}                 
                onChange={handleVehicleChange}                 
                placeholder="MH12AB1234"                 
                style={{ textTransform: 'uppercase' }}                 
                required               
              />             
            </div>              

            <div className="form-group">               
              <label>Vehicle Type (FastTag Class) *</label>               
              <select                 
                name="vehicleType"                 
                className="form-control"                 
                value={vehicleData.vehicleType}                 
                onChange={handleVehicleChange}                 
                required               
              >                 
                <option value="">Select Vehicle Class</option>                 
                <option value="Class 1 - Car / Jeep / Van">Class 1 - Car / Jeep / Van (₹500)</option>                 
                <option value="Class 2 - Light Commercial Vehicle (LCV)">Class 2 - Light Commercial Vehicle (LCV) (₹800)</option>                 
                <option value="Class 3 - Bus / Truck (2 Axles)">Class 3 - Bus / Truck (2 Axles) (₹1200)</option>                 
                <option value="Class 4 - 3-Axle Commercial Vehicles">Class 4 - 3-Axle Commercial Vehicles (₹1500)</option>                 
                <option value="Class 5 - 4 to 6 Axle Vehicles">Class 5 - 4 to 6 Axle Vehicles (₹2000)</option>                 
                <option value="Class 6 - 7 or more Axle Vehicles">Class 6 - 7 or more Axle Vehicles (₹2500)</option>                 
                <option value="Class 7 - Oversized Vehicles (Earth movers, etc.)">Class 7 - Oversized Vehicles (Earth movers, etc.) (₹3000)</option>               
              </select>               
              {vehicleData.vehicleType && (                 
                <small style={{ color: '#007bff', fontSize: '0.9rem', marginTop: '5px', display: 'block' }}>                   
                  FastTag Fee: ₹{vehicleClassAmounts[vehicleData.vehicleType]}                 
                </small>               
              )}             
            </div>              

            <div className="form-group">               
              <label>Chassis Number *</label>               
              <input                 
                type="text"                 
                name="chassisNumber"                 
                className="form-control"                 
                value={vehicleData.chassisNumber}                 
                onChange={handleVehicleChange}                 
                placeholder="MA3EUA42S00783934"                 
                style={{ textTransform: 'uppercase' }}                 
                required               
              />             
            </div>              

            <div className="form-group">               
              <label>Engine Number *</label>               
              <input                 
                type="text"                 
                name="engineNumber"                 
                className="form-control"                 
                value={vehicleData.engineNumber}                 
                onChange={handleVehicleChange}                 
                placeholder="K12M56795"                 
                style={{ textTransform: 'uppercase' }}                 
                required               
              />             
            </div>              

            <div className="form-group">               
              <label>Vehicle Model *</label>               
              <input                 
                type="text"                 
                name="model"                 
                className="form-control"                 
                value={vehicleData.model}                 
                onChange={handleVehicleChange}                 
                placeholder="e.g., Swift, Activa, etc."                 
                required               
              />             
            </div>              

            <div className="form-group">               
              <label>Fuel Type *</label>               
              <select                 
                name="fuelType"                 
                className="form-control"                 
                value={vehicleData.fuelType}                 
                onChange={handleVehicleChange}                 
                required               
              >                 
                <option value="">Select Fuel Type</option>                 
                <option value="Petrol">Petrol</option>                 
                <option value="Diesel">Diesel</option>                 
                <option value="CNG">CNG</option>                 
                <option value="Electric">Electric</option>                 
                <option value="Hybrid">Hybrid</option>               
              </select>             
            </div>              

            <div className="form-group">               
              <label>Registration Year *</label>               
              <input                 
                type="number"                 
                name="registrationYear"                 
                className="form-control"                 
                value={vehicleData.registrationYear}                 
                onChange={handleVehicleChange}                 
                min="1980"                 
                max={new Date().getFullYear()}                 
                required               
              />             
            </div>              

            {/* Vehicle Verification Status */}             
            {isVehicleVerified && (               
              <div style={{                  
                marginTop: '15px',                 
                padding: '15px',                 
                backgroundColor: '#d4edda',                 
                border: '1px solid #c3e6cb',                 
                borderRadius: '8px'               
              }}>                 
                <p style={{                    
                  color: '#155724',                    
                  fontSize: '16px',                    
                  fontWeight: '600',                   
                  margin: '0',                   
                  display: 'flex',                   
                  alignItems: 'center',                   
                  gap: '8px'                 
                }}>                   
                  ✓ All vehicle details verified successfully                 
                </p>               
              </div>             
            )}              

            <div className="form-group">               
              <div className="button-group">                 
                <button                    
                  type="button"                    
                  className="btn btn-secondary"                   
                  onClick={goToPreviousStep}                   
                  disabled={isVehicleVerifying}                 
                >                   
                  Previous                 
                </button>                 
                <button                    
                  type="submit"                    
                  className="btn btn-block"                   
                  disabled={isVehicleVerifying || !vehicleData.vehicleType}                   
                  style={{                     
                    backgroundColor: vehicleData.vehicleType ? '#28a745' : '#6c757d',                     
                    borderColor: vehicleData.vehicleType ? '#28a745' : '#6c757d'                   
                  }}                 
                >                   
                  {isVehicleVerifying ? 'Verifying Vehicle...' :                     
                    vehicleData.vehicleType ?                     
                    'Verify & Continue to Payment' :                     
                    'Select Vehicle Type First'}                 
                </button>               
              </div>               
              <small style={{ color: '#666', fontSize: '0.9rem', marginTop: '5px', display: 'block' }}>                 
                {vehicleData.vehicleType ?                    
                  'Vehicle details will be verified and then you will proceed to payment' :                   
                  'Please select a vehicle class to proceed'}               
              </small>             
            </div>           
          </form>         
        </section>       
      )}

      {/* Step 3: Payment - Updated with UPI Integration */}
      {currentStep === 3 && (
        <section className="form">
          <h2>Payment Details</h2>
          <p style={{ color: '#666', marginBottom: '2rem' }}>
            Complete your FastTag application by making the payment
          </p>
          
          {/* Order Summary Card */}
          <div style={{
            backgroundColor: '#f8f9fa',
            padding: '2rem',
            borderRadius: '12px',
            marginBottom: '2rem',
            border: '1px solid #e9ecef'
          }}>
            <h3 style={{ 
              color: '#495057', 
              marginBottom: '1.5rem',
              fontSize: '1.5rem',
              fontWeight: '600' 
            }}>
              Order Summary
            </h3>
            
            <div style={{ marginBottom: '1rem' }}>
              <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                marginBottom: '0.5rem',
                color: '#6c757d'
              }}>
                <span><strong>Vehicle Registration:</strong></span>
                <span style={{ fontWeight: '600', color: '#495057' }}>
                  {vehicleData.registrationNumber}
                </span>
              </div>
              
              <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                marginBottom: '0.5rem',
                color: '#6c757d'
              }}>
                <span><strong>Vehicle Type:</strong></span>
                <span style={{ fontWeight: '600', color: '#495057' }}>
                  {vehicleData.vehicleType}
                </span>
              </div>
              
              <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                marginBottom: '0.5rem',
                color: '#6c757d'
              }}>
                <span><strong>Vehicle Model:</strong></span>
                <span style={{ fontWeight: '600', color: '#495057' }}>
                  {vehicleData.model}
                </span>
              </div>
              
              <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                marginBottom: '1rem',
                color: '#6c757d'
              }}>
                <span><strong>Customer Name:</strong></span>
                <span style={{ fontWeight: '600', color: '#495057' }}>
                  {personalData.fullName}
                </span>
              </div>
              
              <hr style={{ margin: '1rem 0', border: '1px solid #dee2e6' }} />
              
              <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center',
                fontSize: '1.25rem',
                fontWeight: '700'
              }}>
                <span style={{ color: '#495057' }}>Total Amount:</span>
                <span style={{ 
                  color: '#28a745',
                  fontSize: '1.5rem'
                }}>
                  ₹{vehicleClassAmounts[vehicleData.vehicleType]}
                </span>
              </div>
            </div>
            
            {/* Payment Features */}
            <div style={{
              backgroundColor: '#e7f3ff',
              padding: '1rem',
              borderRadius: '8px',
              marginTop: '1rem'
            }}>
              <h4 style={{ 
                color: '#0066cc', 
                marginBottom: '0.5rem',
                fontSize: '1rem',
                fontWeight: '600'
              }}>
                What you get:
              </h4>
              <ul style={{ 
                margin: '0',
                paddingLeft: '1.5rem',
                color: '#0066cc'
              }}>
                <li>Digital FastTag delivered instantly</li>
                <li>24/7 toll payment convenience</li>
                <li>SMS and email notifications</li>
                <li>Online recharge facility</li>
                <li>Transaction history tracking</li>
              </ul>
            </div>
          </div>
          
          <form onSubmit={handlePaymentSubmit}>
            <div className="form-group">
              <div className="button-group">
                <button
                  type="button"
                  className="btn btn-secondary"
                  onClick={goToPreviousStep}
                >
                  Previous
                </button>
                <button
                  type="submit"
                  className="btn btn-block"
                  style={{
                    backgroundColor: '#28a745',
                    borderColor: '#28a745',
                    fontSize: '1.1rem',
                    padding: '12px 24px',
                    fontWeight: '600'
                  }}
                  disabled={!createdVehicleId || !createdPersonalDetailsId}
                >
                  Pay ₹{vehicleClassAmounts[vehicleData.vehicleType]} via UPI
                </button>
              </div>
              <small style={{ 
                color: '#666', 
                fontSize: '0.9rem', 
                marginTop: '1rem', 
                display: 'block',
                textAlign: 'center'
              }}>
                Secure UPI payment gateway
              </small>
            </div>
          </form>
          
          {/* Security Info */}
          <div style={{
            backgroundColor: '#fff3cd',
            border: '1px solid #ffeaa7',
            borderRadius: '8px',
            padding: '1rem',
            marginTop: '1.5rem',
            textAlign: 'center'
          }}>
            <p style={{ 
              margin: '0',
              color: '#856404',
              fontSize: '0.9rem'
            }}>
              🔒 Your payment is secured with bank-grade encryption
            </p>
          </div>
        </section>
      )}

      {/* UPI Payment Gateway Modal */}
      <UpiPaymentGateway
        isOpen={showPaymentModal}
        onClose={handlePaymentModalClose}
        amount={vehicleClassAmounts[vehicleData.vehicleType]}
        vehicleData={vehicleData}
        personalData={personalData}
        user={user}
        vehicleId={createdVehicleId}
        personalDetailsId={createdPersonalDetailsId}
      />

      {/* Success Message after payment completion */}
      {paymentCompleted && (
        <div style={{
          position: 'fixed',
          top: '50%',
          left: '50%',
          transform: 'translate(-50%, -50%)',
          backgroundColor: '#d4edda',
          border: '2px solid #c3e6cb',
          borderRadius: '12px',
          padding: '2rem',
          zIndex: 1000,
          textAlign: 'center',
          boxShadow: '0 4px 20px rgba(0,0,0,0.1)'
        }}>
          <div style={{ fontSize: '48px', color: '#28a745', marginBottom: '1rem' }}>
            ✅
          </div>
          <h3 style={{ color: '#155724', marginBottom: '1rem' }}>
            FastTag Application Completed!
          </h3>
          <p style={{ color: '#155724', marginBottom: '1rem' }}>
            Redirecting to My Tags page...
          </p>
          <div style={{
            width: '100%',
            height: '4px',
            backgroundColor: '#c3e6cb',
            borderRadius: '2px',
            overflow: 'hidden'
          }}>
            <div style={{
              width: '100%',
              height: '100%',
              backgroundColor: '#28a745',
              animation: 'progress 2s linear forwards'
            }}></div>
          </div>
        </div>
      )}

      <style jsx>{`
        @keyframes progress {
          from { width: 0%; }
          to { width: 100%; }
        }
        
        .button-group {
          display: flex;
          gap: 1rem;
        }
        
        .button-group .btn-secondary {
          flex: 1;
        }
        
        .button-group .btn-block {
          flex: 2;
        }
        
        .progress-bar {
          display: flex;
          justify-content: space-between;
          margin-bottom: 2rem;
          padding: 0 1rem;
        }
        
        .step {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          padding: 0.5rem 1rem;
          border-radius: 8px;
          background-color: #f8f9fa;
          color: #6c757d;
          font-weight: 500;
        }
        
        .step.active {
          background-color: #007bff;
          color: white;
        }
        
        .step span {
          background-color: #fff;
          color: #007bff;
          border-radius: 50%;
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 12px;
          font-weight: bold;
        }
        
        .step.active span {
          background-color: #28a745;
          color: white;
        }
      `}</style>
    </>   
  ); 
}  

export default NewFastTag;